machine:
  environment:
    # GOROOT is not set by default
    GOROOT: ""
    PATH: "/usr/local/go/bin:/usr/local/go_workspace/bin:~/.go_workspace/bin:${PATH}"
    GOPATH: "${HOME}/.go_workspace:/usr/local/go_workspace:${HOME}/.go_project"
    IMPORT_PATH: "github.com/geodatalake/lambdas"

  services:
    - docker

dependencies:
  pre:
    - go get -u github.com/golang/geo/s2
    - go get -u golang.org/x/image/tiff
    - go get -u golang.org/x/image/tiff/lzw
    - go get -u github.com/dustin/go-humanize
    - go get -u gopkg.in/olivere/elastic.v5
    - go get -u github.com/aws/aws-sdk-go/aws
    - go get -u github.com/aws/aws-sdk-go/aws/session
    - go get -u github.com/aws/aws-sdk-go/service/s3
    - go get -u github.com/satori/go.uuid
    - go get -u github.com/smartystreets/go-aws-auth
    - go get -u github.com/go-redis/redis
    - go get -u github.com/eawsy/aws-lambda-go-core/...

  override:
    - rm -rf ${HOME}/.go_workspace/src/github.com/geodatalake/
    - mkdir -p ~/.go_workspace/src/github.com/geodatalake
    - ln -s ${HOME}/${CIRCLE_PROJECT_REPONAME} ${HOME}/.go_workspace/src/github.com/geodatalake/

  post:
    - go get -u github.com/geodatalake/geom
    - go build $IMPORT_PATH/geotiff
    - go build $IMPORT_PATH/lidar
    - go build $IMPORT_PATH/bucket
    - go build $IMPORT_PATH/datalake
    - go build $IMPORT_PATH/elastichelper
    - go build $IMPORT_PATH/proj4support
    - go build $IMPORT_PATH/raster
    - go build $IMPORT_PATH/vector
    - go build $IMPORT_PATH/geoindex
    - go build $IMPORT_PATH/scale
    - GOOS=linux go build -a -ldflags '-s' $IMPORT_PATH/cmd/extractbucket
    - cp extractbucket $CIRCLE_ARTIFACTS
    - GOOS=linux go build -a -ldflags '-s' $IMPORT_PATH/cmd/filegrouper
    - cp filegrouper $CIRCLE_ARTIFACTS
    - GOOS=linux go build -a -ldflags '-s' $IMPORT_PATH/cmd/elastictest
    - cp elastictest $CIRCLE_ARTIFACTS
    - GOOS=linux go build -a -ldflags '-s' $IMPORT_PATH/cmd/indexelastic
    - cp indexelastic $CIRCLE_ARTIFACTS
    - GOOS=linux go build -a -ldflags '-s' $IMPORT_PATH/cmd/processgeo
    - cp processgeo $CIRCLE_ARTIFACTS

test:
  pre:
    - go vet $IMPORT_PATH/geotiff
    - go vet $IMPORT_PATH/lidar
    - go vet $IMPORT_PATH/bucket
    - go vet $IMPORT_PATH/elastichelper
    - go vet $IMPORT_PATH/datalake
    - go vet $IMPORT_PATH/proj4support
    - go vet $IMPORT_PATH/raster
    - go vet $IMPORT_PATH/vector
    - go vet $IMPORT_PATH/geoindex
    - go vet $IMPORT_PATH/scale
    - go vet $IMPORT_PATH/cmd/extractbucket
    - go vet $IMPORT_PATH/cmd/filegrouper
    - go vet $IMPORT_PATH/cmd/elastictest
    - go vet $IMPORT_PATH/cmd/indexelastic
    - go vet $IMPORT_PATH/cmd/processgeo

  override:
    - go test $IMPORT_PATH/geotiff
    - go test $IMPORT_PATH/bucket
    - go test $IMPORT_PATH/datalake
    - go test $IMPORT_PATH/scale
    - go test $IMPORT_PATH/proj4support
    - go test $IMPORT_PATH/elastichelper

deployment:
  dev:
    branch: develop
    owner: geodatalake
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - cp extractbucket cmd/extractbucket
      - docker build -t scale-extract-bucket cmd/extractbucket
      - docker tag -f scale-extract-bucket openwhere/scale-extract-bucket:dev
      - docker push openwhere/scale-extract-bucket:dev
      - cp filegrouper cmd/filegrouper
      - docker build -t scale-file-grouper cmd/filegrouper
      - docker tag -f scale-file-grouper openwhere/scale-file-grouper:dev
      - docker push openwhere/scale-file-grouper:dev
      - cp indexelastic cmd/indexelastic
      - docker build -t scale-index cmd/indexelastic
      - docker tag -f scale-index openwhere/scale-index:dev
      - docker push openwhere/scale-index:dev
      - cp processgeo cmd/processgeo
      - docker build -t scale-processgeo cmd/processgeo
      - docker tag -f scale-processgeo openwhere/scale-processgeo:dev
      - docker push openwhere/scale-processgeo:dev
